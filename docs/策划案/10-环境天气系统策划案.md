# Mindustry 环境天气系统策划案

## 📋 文档信息

**策划类型**: 环境系统机制
**优先级**: 🟡 中优先级
**影响范围**: 全局环境、生产效率、单位状态、视觉体验
**技术架构**: 基于粒子效果和环境属性的动态天气系统
**源码位置**: `type/weather/`

---

## 🎯 系统概述

### 设计理念

环境天气系统是Mindustry中的动态环境机制，通过模拟真实世界的天气现象，为游戏增加环境挑战和战略深度。该系统通过**环境属性修改**、**单位状态影响**和**视觉效果呈现**的方式，让玩家需要根据天气变化调整策略。

### 核心特征

1. **动态环境影响**: 天气直接修改环境属性，影响建筑产能
2. **单位状态效果**: 天气可为单位添加增益或减益状态
3. **视觉沉浸感**: 丰富的粒子效果和音效营造氛围
4. **随机事件性**: 天气具有随机性，增加游戏不确定性
5. **可配置性**: 支持地图制作者自定义天气规则

### 系统架构

```
Weather (基类)
├── ParticleWeather (粒子天气)
│   ├── 雪 (Snow)
│   ├── 沙暴 (Sandstorm)
│   ├── 孢子风暴 (Sporestorm)
│   ├── 雾 (Fog)
│   └── 悬浮粒子 (Suspend Particles)
├── RainWeather (降雨天气)
│   └── 雨 (Rain)
├── MagneticStorm (磁暴) [未实现]
└── SolarFlare (太阳耀斑) [未实现]
```

**核心类定义**:
- `Weather`: 天气基类 (`type/Weather.java`)
- `ParticleWeather`: 粒子天气基类 (`type/weather/ParticleWeather.java`)
- `RainWeather`: 降雨天气类 (`type/weather/RainWeather.java`)
- `WeatherState`: 天气状态实体组件

---

## 🌦️ 已实现天气类型

### 1. 降雨系统 (Rain)

**基础参数**:
- **持续时间**: 默认10分钟
- **环境影响**: 光照 -0.2, 水含量 +0.2
- **状态效果**: 湿润 (Wet)
- **音效**: rain.ogg (音量 0.25)

**视觉效果**:
```
雨滴参数:
- 长度: 8-40像素
- 速度: X轴 1.5, Y轴 5.0
- 密度: 1200粒子/区域
- 颜色: #7a95ea (蓝色)
- 线条粗细: 0.75
```

**水花效果**:
- **水花贴图**: 12张连续动画帧 (splash-0 ~ splash-11)
- **生成规律**: 时间缩放 22x
- **液体检测**: 仅在水面产生蓝色水花，陆地产生白色飞溅

**湿润状态详情**:
- **移动速度**: 94% (减速6%)
- **状态颜色**: 皇家蓝 (#4169e1)
- **效果几率**: 9%
- **转换伤害**: 与焦油结合造成14点伤害

### 2. 降雪系统 (Snow)

**基础参数**:
- **持续时间**: 默认10分钟
- **环境影响**: 光照 -0.15
- **粒子类型**: particle (圆形白色粒子)
- **音效**: windhowl.ogg (风啸声)

**粒子参数**:
```
雪花效果:
- 大小范围: 2.6-13像素
- 密度: 1200粒子/区域
- 透明度: 1.0 (完全不透明)
- 颜色: 白色
- 风向: 随机方向
```

**音效特性**:
- **基础音量**: 0 (静音开始)
- **音量振荡**: 幅度 1.5, 周期 1100帧
- **最小音量**: 0.02

### 3. 沙暴系统 (Sandstorm)

**基础参数**:
- **持续时间**: 7分钟
- **环境影响**: 光照 -0.1, 水含量 -0.1
- **不透明度**: 35% (半透明效果)
- **风力作用**: 0.1 (影响单位移动)

**视觉效果**:
```
沙尘粒子:
- 颜色: #f7cba4 (沙黄色)
- 大小: 70-140像素
- 透明度: 0-0.2 (变化范围)
- 密度: 1500粒子/区域
- 基础速度: 5.4
```

**噪声层效果**:
- **启用噪声渲染**: true
- **使用风向量**: true
- **噪声纹理**: noiseAlpha.png

**音效系统**:
- **风声**: wind.ogg
- **音量**: 0.8 (强风效果)

### 4. 孢子风暴 (Sporestorm)

**基础参数**:
- **持续时间**: 7分钟
- **环境影响**: 孢子含量 +1.0, 光照 -0.15
- **状态效果**: 孢子缓慢 (SporeSlowed)
- **地面单位**: 不受影响 (statusGround = false)

**粒子特效**:
```
孢子粒子:
- 颜色: #7457ce (紫色)
- 贴图: circle-small (小圆形)
- 大小: 2.5-5像素
- 透明度: 0.1-0.8
- 密度: 2000粒子/区域
```

**孢子缓慢状态**:
- **移动速度**: 80% (减速20%)
- **状态颜色**: 孢子色调
- **影响目标**: 仅空中单位

### 5. 雾系统 (Fog)

**基础参数**:
- **持续时间**: 15分钟 (最长)
- **环境影响**: 光照 -0.3, 水含量 +0.05
- **不透明度**: 47%
- **无粒子效果**: 仅噪声渲染

**噪声系统**:
```
雾层参数:
- 层数: 3层
- 速度倍率: 2.0 (层间)
- 透明度倍率: 0.7
- 缩放倍率: 0.6
- 颜色倍率: 0.8
```

**运动特性**:
- **基础速度**: 0.05 (极慢)
- **X轴速度**: 1.0
- **Y轴速度**: 0.01
- **噪声缩放**: 1100
- **使用风向**: false (自主移动)

### 6. 悬浮粒子 (Suspend Particles)

**特殊属性**:
- **隐藏状态**: true (不在UI显示)
- **仅影响空中**: statusGround = false
- **永久存在**: 由地图环境决定

**粒子参数**:
```
悬浮效果:
- 颜色: #a7c1fa (淡蓝色)
- 大小: 1.4-4像素
- 透明度: 0.5-1.0
- 密度: 10000粒子/区域 (最高)
- 速度: 0.03 (几乎静止)
```

---

## ⚡ 天气系统核心机制

### 天气状态组件 (WeatherState)

**生命周期管理**:
```java
// 透明度渐变公式
if (life < fadeTime) {
    opacity = min(life / fadeTime, opacity);
} else {
    opacity = lerpDelta(opacity, 1.0f, 0.004f);
}

// 生命值衰减
life -= Time.delta;
```

**关键参数**:
- **淡入时间**: 4分钟 (240秒)
- **不透明度插值**: 0.004 (渐变速度)
- **风向量**: 随机方向单位向量

### 粒子渲染系统

**粒子绘制公式** (`Weather.drawParticles`):
```java
// 粒子总数计算
int total = (int)(area / density * intensity);

// 粒子位置计算
float x = random(worldWidth) + Time.time * windx * scl2;
float y = random(worldHeight) + Time.time * windy * scl;

// 正弦波动
x += sin(y, random(sinSclMin, sinSclMax), random(sinMagMin, sinMagMax));

// 循环边界处理
x = mod(x, region.width);
y = mod(y, region.height);
```

**噪声渲染公式** (`Weather.drawNoise`):
```java
// 速度和缩放
float speed = baseSpeed * intensity;
float scale = 1.0f / noiseScale;
float scroll = Time.time * scale + offset;

// 纹理滚动
texture.scroll(-windx * scroll, -windy * scroll);
```

### 环境属性影响

**光照属性影响** (在`SolarGenerator.updateTile`):
```java
productionEfficiency = solarMultiplier * max(0,
    Attribute.light.env() + lightingBonus
);
```

**属性累加机制** (在`Logic.update`):
```java
state.envAttrs.clear();
state.envAttrs.add(state.rules.attributes);
Groups.weather.each(w -> state.envAttrs.add(w.weather.attrs, w.opacity));
```

### 单位状态效果

**状态应用时机**:
```java
if (state.effectTimer <= 0) {
    state.effectTimer = statusDuration - 5f;
    Groups.unit.each(u -> {
        if (u.checkTarget(statusAir, statusGround)) {
            u.apply(status, statusDuration);
        }
    });
} else {
    state.effectTimer -= Time.delta;
}
```

**风力影响**:
```java
float speed = force * state.intensity * Time.delta;
if (speed > 0.001f) {
    float windx = state.windVector.x * speed;
    float windy = state.windVector.y * speed;
    for (Unit unit : Groups.unit) {
        unit.impulse(windx, windy);
    }
}
```

---

## 🎛️ 天气控制系统

### WeatherEntry 配置

**天气事件配置**:
```java
public class WeatherEntry {
    Weather weather;                    // 天气类型
    float minFrequency, maxFrequency;   // 事件间隔 (秒)
    float minDuration, maxDuration;     // 持续时间 (秒)
    float cooldown;                     // 当前冷却时间
    float intensity = 1f;               // 强度 (0-1)
    boolean always = false;             // 是否永久激活
}
```

**默认时间配置**:
```java
// 标准配置构造器
public WeatherEntry(Weather weather) {
    minFrequency = weather.duration * 2f;      // 最短间隔 = 2倍持续时间
    maxFrequency = weather.duration * 6f;      // 最长间隔 = 6倍持续时间
    minDuration = weather.duration / 2f;       // 最短持续 = 0.5倍标准时间
    maxDuration = weather.duration * 1.5f;     // 最长持续 = 1.5倍标准时间
}
```

### 天气生成算法

**启动时初始化** (在`Logic.PlayEvent`):
```java
var randomWeather = state.rules.weather.copy().shuffle();
float sum = 0f;
for (var weather : randomWeather) {
    weather.cooldown = sum + random(weather.maxFrequency);
    sum += weather.cooldown;
}
```

**动态更新循环** (在`Logic.updateWeather`):
```java
for (WeatherEntry entry : state.rules.weather) {
    entry.cooldown -= Time.delta;

    if ((entry.cooldown < 0 || entry.always) && !entry.weather.isActive()) {
        float duration = entry.always ?
            POSITIVE_INFINITY :
            random(entry.minDuration, entry.maxDuration);

        entry.cooldown = duration + random(entry.minFrequency, entry.maxFrequency);

        Tmp.v1.setToRandomDirection();
        Call.createWeather(entry.weather, entry.intensity, duration,
                          Tmp.v1.x, Tmp.v1.y);
    }
}
```

### 网络同步

**服务器远程调用**:
```java
@Remote(called = Loc.server)
public static void createWeather(Weather weather, float intensity,
                                float duration, float windX, float windY) {
    weather.create(intensity, duration).windVector.set(windX, windY);
}
```

---

## 🔮 未实现天气类型设计

### 磁暴天气 (MagneticStorm)

**设计概念**: 强磁场干扰电子设备运行

**影响机制**:
```java
// 建议参数
duration = 8f * Time.toMinutes;        // 持续8分钟
attrs.set(Attribute.heat, 0.3f);       // 增加热量属性
opacityMultiplier = 0.6f;              // 60%不透明度
```

**电子设备影响**:
- **雷达干扰**: 单位视野范围 -30%
- **通信中断**: 单位AI响应延迟 +50%
- **电力波动**: 电力建筑效率 85-115% 随机波动
- **传送失效**: 相位传送建筑临时失效

**视觉效果**:
- **电弧效果**: 建筑间随机闪电
- **屏幕干扰**: UI轻微闪烁效果
- **磁场线**: 弯曲的能量线条粒子
- **颜色主调**: 电蓝色 (#00ffff)

**状态效果**:
- **电磁干扰** (EMPed): 降低单位精确度和射击频率

### 太阳耀斑 (SolarFlare)

**设计概念**: 太阳活动增强影响太阳能系统

**影响机制**:
```java
// 建议参数
duration = 12f * Time.toMinutes;       // 持续12分钟
attrs.set(Attribute.light, 2.0f);      // 光照大幅增强
attrs.set(Attribute.heat, 0.8f);       // 高热量增加
```

**太阳能系统影响**:
- **过载保护**: 太阳能板效率先增至200%，后降至50%
- **热量激增**: 所有热量建筑产热+50%
- **光合反应**: 孢子培养器产量+100%

**负面效应**:
- **过热损坏**: 电子设备有概率过热损坏
- **辐射伤害**: 露天单位受到轻微持续伤害
- **视野干扰**: 亮度过高影响视觉辨识

**视觉效果**:
- **强光效果**: 整体画面增亮
- **热浪扭曲**: 地面热浪上升效果
- **太阳光束**: 从屏幕上方射下的光柱
- **颜色主调**: 金橙色 (#ffa500)

**状态效果**:
- **过热** (Overheated): 单位移动速度-10%，但攻击力+15%

---

## 🏭 关联系统分析

### 1. 建筑生产系统

**太阳能发电机** (`SolarGenerator`):
```java
// 效率计算公式
productionEfficiency = enabled ?
    state.rules.solarMultiplier * max(0,
        Attribute.light.env() + lightingBonus
    ) : 0f;
```

**影响计算**:
- **晴天**: 效率 100%
- **雪天**: 效率 85% (light -0.15)
- **雾天**: 效率 70% (light -0.3)
- **沙暴**: 效率 90% (light -0.1)

**水提取器** (`AttributeCrafter` with `Attribute.water`):
```java
// 提取效率公式
efficiency = baseEfficiency + min(maxBoost,
    boostScale * sumAttribute(Attribute.water, x, y)
);
```

**雨天加成**:
- **基础效率**: 100%
- **雨天效率**: 120% (water +0.2)
- **雾天效率**: 105% (water +0.05)

**孢子培养器** (`AttributeCrafter` with `Attribute.spores`):
- **孢子风暴期间**: 产量翻倍 (spores +1.0)
- **正常天气**: 标准产量

### 2. 单位作战系统

**移动能力影响**:
```java
// 湿润状态
speedMultiplier = 0.94f;               // 移动速度 -6%

// 孢子缓慢状态
speedMultiplier = 0.8f;                // 移动速度 -20%

// 风力推动
unit.impulse(windx, windy);            // 额外移动向量
```

**战术意义**:
- **雨天**: 地面单位机动性降低，利于防守
- **孢子风暴**: 空军效能严重下降
- **沙暴**: 所有单位都受风力影响，需考虑风向

### 3. 视觉与音效系统

**渲染层次**:
```java
Draw.draw(Layer.weather, () -> weather.drawOver());      // 天气前景层
Draw.draw(Layer.debris, () -> weather.drawUnder());      // 天气背景层
```

**音效控制**:
```java
// 动态音量计算
float noise = soundVolOscMag > 0 ?
    abs(Noise.rawNoise(Time.time / soundVolOscScl)) * soundVolOscMag : 0;
control.sound.loop(sound, max((soundVol + noise) * state.opacity, soundVolMin));
```

### 4. 地图编辑器集成

**规则配置** (`Rules.weather`):
```java
public Seq<WeatherEntry> weather = new Seq<>(1);
```

**地图制作者可配置**:
- 天气类型和强度
- 出现频率和持续时间
- 永久天气设置
- 天气序列编排

---

## 📊 数值平衡与调优

### 核心数值表

| 天气类型 | 持续时间 | 冷却范围 | 强度 | 主要影响 |
|---------|----------|----------|------|----------|
| 雨 | 10分钟 | 20-60分钟 | 1.0 | 光照-20%, 水含量+20% |
| 雪 | 10分钟 | 20-60分钟 | 1.0 | 光照-15% |
| 沙暴 | 7分钟 | 14-42分钟 | 1.0 | 光照-10%, 水含量-10%, 风力0.1 |
| 孢子风暴 | 7分钟 | 14-42分钟 | 1.0 | 光照-15%, 孢子+100% |
| 雾 | 15分钟 | 30-90分钟 | 1.0 | 光照-30%, 水含量+5% |

### 性能优化参数

**粒子密度控制**:
- **雨**: 1200 (中等)
- **雪**: 1200 (中等)
- **沙暴**: 1500 (较高)
- **孢子风暴**: 2000 (高)
- **悬浮粒子**: 10000 (最高，但轻量)

**渲染优化**:
- 视野外粒子剔除
- 距离LOD调整
- 透明度阈值优化

---

## 🔧 技术实现要点

### 关键性能考虑

1. **粒子系统优化**:
   - 使用对象池避免频繁分配
   - 视锥剔除减少渲染负载
   - 粒子LOD系统

2. **网络同步优化**:
   - 仅服务器生成天气事件
   - 客户端本地渲染
   - 压缩天气状态数据

3. **内存管理**:
   - 纹理复用机制
   - 音效缓存策略
   - 临时对象控制

### 扩展性设计

**MOD支持**:
- 自定义天气类型注册
- 天气效果叠加系统
- 可配置天气参数

**多平台兼容**:
- 移动设备性能档位
- 桌面端高质量效果
- 服务器轻量级模式

---

## 🎮 游戏体验影响

### 策略深度提升

1. **资源管理**: 玩家需根据天气预期调整生产布局
2. **战术计划**: 天气状况影响作战时机选择
3. **基地设计**: 考虑天气因素的防御工事布置

### 沉浸感增强

1. **视觉体验**: 丰富的天气效果增加游戏真实感
2. **听觉反馈**: 配套音效营造氛围
3. **动态变化**: 打破静态环境，增加新鲜感

### 平衡性考量

1. **随机性控制**: 避免过度依赖运气
2. **影响度适中**: 不让天气主导游戏节奏
3. **适应性机制**: 给玩家充分的应对时间

---

## 🚀 后续开发建议

### 立即可实现功能

1. **磁暴天气**: 完成电子设备干扰机制
2. **太阳耀斑**: 实现太阳能系统波动效果
3. **天气预警**: 添加天气预报系统

### 长期发展方向

1. **复合天气**: 多种天气同时出现
2. **季节系统**: 长期天气变化周期
3. **星球差异**: 不同星球的独特天气
4. **气候变化**: 玩家行为影响环境

### 技术债务清理

1. **代码重构**: 统一天气接口设计
2. **性能优化**: 移动设备适配
3. **测试覆盖**: 自动化天气系统测试
4. **文档完善**: API文档和开发指南

---

*本策划案基于Mindustry源码深度分析，为开发团队提供详实的技术实现指导，可直接用于功能开发和系统优化。*