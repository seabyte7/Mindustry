# Mindustry 项目概述

## 项目简介

Mindustry是一款使用Java开发的多平台塔防/实时战略游戏，具有工厂建设、资源管理和防御元素。项目采用模块化架构设计，支持桌面、移动端和服务器部署。

## 技术栈

### 核心技术
- **语言**: Java 17 (编译目标Java 8兼容性)
- **框架**: Arc框架 (基于LibGDX的游戏引擎)
- **构建工具**: Gradle 7.x
- **图形**: OpenGL 2.0/3.0
- **网络**: 自定义TCP/UDP协议
- **脚本**: Rhino JavaScript引擎

### 平台支持
- **Desktop**: Windows, macOS, Linux
- **Mobile**: Android, iOS
- **Server**: 无头服务器模式
- **Web**: 理论支持但主要为原生平台优化

## 项目结构

### 模块划分

```
Mindustry/
├── core/           # 核心游戏逻辑，所有平台共享
├── desktop/        # 桌面平台启动器和本地库
├── server/         # 专用服务器实现
├── android/        # Android平台特定代码
├── ios/           # iOS平台包装器
├── tools/         # 构建工具和精灵打包工具
├── tests/         # JUnit测试套件
└── annotations/   # 注解处理器和代码生成
```

### Core模块详细结构

```
core/src/mindustry/
├── ai/            # AI系统：寻路、单位控制、战略AI
├── async/         # 异步处理：多线程任务管理
├── audio/         # 音频系统：声音管理和播放
├── content/       # 游戏内容定义：方块、单位、物品等
├── core/          # 核心系统：游戏循环、状态管理
├── ctype/         # 内容类型：内容加载和注册系统
├── editor/        # 地图编辑器：地图创建和编辑工具
├── entities/      # 实体系统：ECS架构、组件系统
├── game/          # 游戏逻辑：规则、事件、队伍管理
├── graphics/      # 图形系统：渲染、特效、着色器
├── input/         # 输入处理：键盘、鼠标、触摸控制
├── io/           # 输入输出：存档、地图加载、数据序列化
├── logic/        # 逻辑编程：可编程方块、逻辑处理器
├── maps/         # 地图系统：地图生成、加载、管理
├── mod/          # 模组系统：MOD加载、脚本执行
├── net/          # 网络系统：多人游戏、数据包处理
├── service/      # 服务系统：外部服务集成
├── type/         # 类型定义：游戏对象类型
├── ui/           # 用户界面：UI组件、对话框
└── world/        # 世界系统：方块、建筑、地形
```

## 核心设计原则

### 1. 模块化架构
- 每个模块职责明确，低耦合高内聚
- 使用ApplicationListener模式管理模块生命周期
- 事件驱动架构，模块间通过事件通信

### 2. 平台兼容性
- 核心逻辑与平台无关，放在core模块
- 严格的Java 8兼容性（Android/iOS要求）
- 避免使用平台特定的API

### 3. 性能优化
- 零内存分配的主循环设计
- 对象池（Pools）重用机制
- 专用集合类型（IntSeq, ObjectMap等）
- 静态变量重用（Tmp类）

### 4. 代码生成
- 使用注解处理器自动生成重复代码
- 网络同步代码自动生成（@Remote注解）
- 实体类自动生成（ECS组件组合）

## 关键设计模式

### ApplicationListener模式
```java
public interface ApplicationListener {
    void init();          // 初始化
    void update();        // 每帧更新
    void resize();        // 窗口大小改变
    void pause();         // 暂停
    void resume();        // 恢复
    void dispose();       // 资源清理
}
```

### 事件系统
```java
// 事件定义
public class BlockDestroyEvent {
    public Tile tile;
    public Building build;
    public Team team;
}

// 事件监听
Events.on(BlockDestroyEvent.class, event -> {
    // 处理方块摧毁事件
});

// 事件触发
Events.fire(new BlockDestroyEvent());
```

### 内容注册系统
```java
// 内容定义（在content包中）
public class Blocks {
    public static Block copperWall, titaniumWall;

    public static void load() {
        copperWall = new Wall("copper-wall") {{
            health = 80;
            requirements(Category.defense, ItemStack.with(Items.copper, 6));
        }};
    }
}
```

## 构建和运行

### 开发环境要求
- JDK 17（其他版本不兼容）
- Git（版本控制）
- 可选：Android SDK（Android构建）

### 常用命令
```bash
# 运行桌面版
./gradlew desktop:run

# 构建桌面版
./gradlew desktop:dist

# 运行服务器
./gradlew server:run

# 运行测试
./gradlew tests:test

# 打包精灵
./gradlew tools:pack

# 清理缓存
./gradlew clearCache
```

## 资源管理

### 资产结构
```
core/assets/
├── sprites/       # 游戏精灵图（自动打包成图集）
├── sounds/        # 音效文件
├── music/         # 背景音乐
├── maps/          # 内置地图
├── bundles/       # 本地化文件
└── shaders/       # 着色器代码
```

### 资产加载
- 使用Arc的AssetManager异步加载
- 纹理图集自动生成和加载
- 支持模组资产覆盖

## 特色功能

### 1. 实时代码生成
- 构建时生成`mindustry.gen`包
- 网络同步代码自动生成
- 实体类根据组件自动组合

### 2. 逻辑编程系统
- 游戏内可编程方块
- 类似汇编的指令集
- 支持复杂的自动化逻辑

### 3. 模组系统
- JavaScript脚本支持
- 内容添加和修改
- 图形资源替换

### 4. 多人游戏
- 专用服务器模式
- 客户端-服务器同步
- 支持大规模多人对战

## 开发工作流

### 1. 添加新内容
1. 在`content/`包中定义内容
2. 添加必要的资产文件
3. 运行`./gradlew tools:pack`打包精灵
4. 测试和调试

### 2. 修改游戏逻辑
1. 在相应的模块中修改代码
2. 确保遵循性能要求（无分配原则）
3. 添加单元测试
4. 验证多人同步

### 3. UI开发
1. 使用Scene2D UI框架
2. 遵循现有的Dialog和Fragment模式
3. 支持多分辨率和国际化

## 下一步阅读

- [架构设计.md](./架构设计.md) - 深入了解系统架构
- [内容系统.md](./内容系统.md) - 学习如何添加游戏内容
- [实体系统和代码生成.md](./实体系统和代码生成.md) - 理解ECS架构
- [开发实践指南.md](./开发实践指南.md) - 掌握开发最佳实践